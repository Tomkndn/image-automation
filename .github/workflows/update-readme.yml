name: Build, Screenshot & Update README

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build-and-screenshot:
    runs-on: ubuntu-latest

    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_NAME: image-automation

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ³ Log in to Docker Hub
        run: echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin

      - name: ğŸ“¦ Build Docker image
        run: docker build --no-cache -t $DOCKERHUB_USERNAME/$IMAGE_NAME .

      - name: ğŸš€ Push to Docker Hub
        run: docker push $DOCKERHUB_USERNAME/$IMAGE_NAME

      - name: ğŸ§ª Start container
        run: docker run -d -p 3000:80 --name web $DOCKERHUB_USERNAME/$IMAGE_NAME

      - name: ğŸ’¤ Wait for container to be ready
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "âœ… App is ready!"
              exit 0
            fi
            echo "Waiting for app... ($i)"
            sleep 2
          done
          echo "âŒ App did not start in time"
          exit 1

      - name: ğŸ“¸ Take screenshot with Puppeteer
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Puppeteer & Capture Screenshot
        run: |
          npm install puppeteer
          node screenshot.js

      - name: ğŸ“‚ Commit updated screenshot and README
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add preview-*.png README.md
          git commit -m "ğŸ¤– Updated screenshot and README with new image"
          git push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
