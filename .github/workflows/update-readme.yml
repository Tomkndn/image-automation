name: Build, Screenshot & Update README

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build-and-screenshot:
    runs-on: ubuntu-latest

    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_NAME: image-automation

    steps:
      - name: ðŸ›Žï¸ Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ³ Log in to Docker Hub
        run: echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin

      - name: ðŸ“¦ Build Docker image
        run: docker build --no-cache -t $DOCKERHUB_USERNAME/$IMAGE_NAME .

      - name: ðŸš€ Push to Docker Hub
        run: docker push $DOCKERHUB_USERNAME/$IMAGE_NAME

      - name: ðŸ§ª Start container
        run: docker run -d -p 3000:80 --name web $DOCKERHUB_USERNAME/$IMAGE_NAME

      - name: ðŸ’¤ Wait for container to be ready
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "âœ… App is ready!"
              exit 0
            fi
            echo "Waiting for app... ($i)"
            sleep 2
          done
          echo "âŒ App did not start in time"
          exit 1

      - name: ðŸ“¸ Take screenshot with Puppeteer
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: ðŸ“¦ Install Puppeteer & Capture Screenshot
        run: |
          npm install puppeteer
          node screenshot.js

      - name: ðŸ“ Update README with screenshot
        run: |
          if grep -q "!\[Preview\]" README.md; then
            # Replace existing preview line
            sed -i 's|!\[Preview\](.*)|![Preview](preview.png)|' README.md
          else
            # Append preview to end of README
            echo -e "\n![Preview](preview.png)" >> README.md
          fi

      - name: ðŸ“‚ Commit updated screenshot
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add preview.png README.md
          git commit -m "ðŸ¤– Updated screenshot"
          git push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
